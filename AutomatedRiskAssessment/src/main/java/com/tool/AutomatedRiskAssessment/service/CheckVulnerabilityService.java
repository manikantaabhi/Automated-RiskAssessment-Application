package com.tool.AutomatedRiskAssessment.service;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import com.tool.AutomatedRiskAssessment.model.*;
import com.tool.AutomatedRiskAssessment.repo.MetricRepository;
import com.tool.AutomatedRiskAssessment.repo.UserRepository;
import com.tool.AutomatedRiskAssessment.repo.VulnerabilityRepository;

import java.util.*;

@Service
public class CheckVulnerabilityService {

    @Autowired
    private VulnerabilityRepository vulnerabilityRepository;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private MetricRepository metricRepository;

    private final RestTemplate restTemplate = new RestTemplate();

    private static final String NVD_API_URL = "https://services.nvd.nist.gov/rest/json/cves/2.0";

    public List<Vulnerability> getVulnerabilities(String company, String product, String version, String keywords) {
        String cpeName = String.format("cpe:2.3:o:%s:%s:%s:*:*:*:*:*:*:*", company, product, version);
        if (keywords == null) keywords = "";

        String url = NVD_API_URL.concat("?cpeName=").concat(cpeName).concat("&keywordSearch=").concat(keywords);

        Map<String, Object> response = restTemplate.getForObject(url, Map.class);
        if (response == null || !response.containsKey("vulnerabilities")) {
            return Collections.emptyList();
        }

        List<Map<String, Object>> cveItems = (List<Map<String, Object>>) response.get("vulnerabilities");
        List<Vulnerability> vulnerabilities = new ArrayList<>();

        for (Map<String, Object> cveItem : cveItems) {
            Map<String, Object> cveData = (Map<String, Object>) cveItem.get("cve");
            String cveId = (String) cveData.get("id");

            // Extract other fields like sourceIdentifier, published, etc.
            String sourceIdentifier = (String) cveData.get("sourceIdentifier");
            String published = (String) cveData.get("published");
            String lastModified = (String) cveData.get("lastModified");
            String vulnStatus = (String) cveData.get("vulnStatus");

            // Extract Description (considering language priority, English first)
            String description = "No description available";
            List<Map<String, Object>> descriptions = (List<Map<String, Object>>) cveData.get("descriptions");
            for (Map<String, Object> desc : descriptions) {
                if ("en".equals(desc.get("lang"))) {
                    description = (String) desc.get("value");
                    break;
                }
            }

            // Check if Vulnerability already exists
            Vulnerability vulnerability = vulnerabilityRepository.findByCveId(cveId).orElse(null);
            if (vulnerability == null) {
                vulnerability = new Vulnerability(
                    null, // id auto-generated
                    cveId,
                    sourceIdentifier,
                    published,
                    lastModified,
                    vulnStatus,
                    description,
                    new ArrayList<>(),  // Empty metric list to be populated later
                    new ArrayList<>()   // Empty reference list
                );

                // Handle References
                List<VulnerabilityReference> references = new ArrayList<>();
                if (cveData.containsKey("references")) {
                    List<Map<String, Object>> referenceData = (List<Map<String, Object>>) cveData.get("references");
                    for (Map<String, Object> ref : referenceData) {
                        String urlRef = (String) ref.get("url");

                        // Create the VulnerabilityReference and set the corresponding URL
                        VulnerabilityReference reference = new VulnerabilityReference();
                        reference.setUrl(urlRef);
                        reference.setSource((String) ref.get("source"));
                        reference.setVulnerability(vulnerability); // Associate with the vulnerability

                        // Add to references list
                        references.add(reference);
                    }
                }
                vulnerability.setReferences(references);

                // Handle Metrics
                List<Metric> allMetrics = new ArrayList<>();
                if (cveData.containsKey("metrics")) {
                    Map<String, Object> metricsData = (Map<String, Object>) cveData.get("metrics");

                    if (metricsData.containsKey("cvssMetricV2")) {
                        List<Map<String, Object>> cvssMetrics = (List<Map<String, Object>>) metricsData.get("cvssMetricV2");
                        for (Map<String, Object> metric : cvssMetrics) {
                            Map<String, Object> cvssData = (Map<String, Object>) metric.get("cvssData");

                            // Check if metric already exists to avoid duplicates
                            String vectorString = (String) cvssData.get("vectorString");
                            Metric existingMetric = metricRepository.findByVulnerabilityAndSource(vulnerability, vectorString);

                            if (existingMetric == null) {
                                Metric metricEntity = new Metric(
                                    vectorString,
                                    (Double) cvssData.get("baseScore"),
                                    (String) metric.get("baseSeverity"),
                                    vulnerability
                                );
                                // Save metric to the repository
                                metricRepository.save(metricEntity);
                                allMetrics.add(metricEntity);
                            } else {
                                allMetrics.add(existingMetric);
                            }
                        }
                    }
                }
                // Set metrics to vulnerability
                vulnerability.setMetrics(allMetrics);

                // Save the vulnerability
                vulnerability = vulnerabilityRepository.save(vulnerability);
            }

            vulnerabilities.add(vulnerability);
        }

        // Return the list of vulnerabilities
        return vulnerabilities;
    }
}
